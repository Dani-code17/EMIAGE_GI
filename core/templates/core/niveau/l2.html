{% extends 'core/base.html' %}
{% load static %}

{% block title %}E-MIAGE-GI | Licence 2 | {{ category|default:"Documents" }}{% endblock %}

{% block content %}
<section class="pt-28 pb-16 px-6 bg-glass">
    <div class="max-w-6xl mx-auto">
        <h2 class="text-3xl font-display font-bold mb-12 text-center">
            Licence 2 MIAGE - 
            {% if semestre == 's1' %}Semestre 1
            {% elif semestre == 's2' %}Semestre 2
            {% else %}Sélectionnez un semestre
            {% endif %}
            {% if category %}
                - {{ category|title }}
            {% endif %}
        </h2>
        
        <!-- Sélection du semestre -->
        <div class="mb-8 text-center">
            <label for="semestre-select" class="text-gray-300 text-lg font-bold">Sélectionnez un semestre :</label>
            <select id="semestre-select" class="bg-dark text-gray-300 py-2 px-4 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" onchange="changeSemestre(this.value)">
                <option value="s1" {% if semestre == 's1' %}selected{% endif %}>Semestre 1</option>
                <option value="s2" {% if semestre == 's2' %}selected{% endif %}>Semestre 2</option>
            </select>
        </div>

        <!-- Sélection UE / ECUE -->
        <div class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-300 text-sm font-semibold mb-2">UE</label>
                    <select id="ue-select" class="w-full bg-dark text-gray-300 py-2 px-4 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" onchange="changeUE(this.value)">
                        <option value="">Choisir une UE...</option>
                        {% for ue in ues %}
                            <option value="{{ ue.slug }}" {% if selected_ue and selected_ue.slug == ue.slug %}selected{% endif %}>{{ ue.code }} - {{ ue.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-semibold mb-2">ECUE</label>
                    <select id="ecue-select" class="w-full bg-dark text-gray-300 py-2 px-4 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" onchange="changeECUE(this.value)" {% if not selected_ue %}disabled{% endif %}>
                        <option value="">Choisir une ECUE...</option>
                        {% if ecues %}
                            {% for e in ecues %}
                                <option value="{{ e.slug }}" {% if selected_ecue and selected_ecue.slug == e.slug %}selected{% endif %}>{{ e.name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Navigation des catégories -->
        <div class="mb-8 flex justify-center space-x-4">
            <a href="?semestre={{ semestre }}{% if selected_ue %}&ue={{ selected_ue.slug }}{% endif %}{% if selected_ecue %}&ecue={{ selected_ecue.slug }}{% endif %}&category=maquettes" 
               class="px-4 py-2 rounded-lg {% if category == 'maquettes' %}bg-primary text-white{% else %}bg-dark text-gray-300{% endif %} hover:bg-primary hover:text-white transition">
                Maquettes
            </a>
            <a href="?semestre={{ semestre }}{% if selected_ue %}&ue={{ selected_ue.slug }}{% endif %}{% if selected_ecue %}&ecue={{ selected_ecue.slug }}{% endif %}&category=cours" 
               class="px-4 py-2 rounded-lg {% if not selected_ecue %}opacity-50 cursor-not-allowed{% endif %} {% if category == 'cours' %}bg-primary text-white{% else %}bg-dark text-gray-300{% endif %} hover:bg-primary hover:text-white transition" {% if not selected_ecue %}aria-disabled="true" onclick="return false;"{% endif %}>
                Cours
            </a>
            <a href="?semestre={{ semestre }}{% if selected_ue %}&ue={{ selected_ue.slug }}{% endif %}{% if selected_ecue %}&ecue={{ selected_ecue.slug }}{% endif %}&category=td_tp" 
               class="px-4 py-2 rounded-lg {% if not selected_ecue %}opacity-50 cursor-not-allowed{% endif %} {% if category == 'td_tp' %}bg-primary text-white{% else %}bg-dark text-gray-300{% endif %} hover:bg-primary hover:text-white transition" {% if not selected_ecue %}aria-disabled="true" onclick="return false;"{% endif %}>
                TD & TP
            </a>
            <a href="?semestre={{ semestre }}{% if selected_ue %}&ue={{ selected_ue.slug }}{% endif %}{% if selected_ecue %}&ecue={{ selected_ecue.slug }}{% endif %}&category=sujets" 
               class="px-4 py-2 rounded-lg {% if not selected_ecue %}opacity-50 cursor-not-allowed{% endif %} {% if category == 'sujets' %}bg-primary text-white{% else %}bg-dark text-gray-300{% endif %} hover:bg-primary hover:text-white transition" {% if not selected_ecue %}aria-disabled="true" onclick="return false;"{% endif %}>
                Anciens Sujets
            </a>
        </div>

        <!-- Contenu -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% if documents %}
                {% for doc in documents %}
                    <div class="glass-card p-6 rounded-xl">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                {% if doc.category == 'COURS' %}
                                    <i class="fas fa-book text-2xl text-primary"></i>
                                {% elif doc.category == 'TD_TP' %}
                                    <i class="fas fa-tools text-2xl text-secondary"></i>
                                {% elif doc.category == 'MAQUETTES' %}
                                    <i class="fas fa-drafting-compass text-2xl text-accent"></i>
                                {% else %}
                                    <i class="fas fa-file-alt text-2xl text-gray-400"></i>
                                {% endif %}
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold mb-2">{{ doc.title }}</h3>
                                {% if doc.ecue %}
                                <p class="text-sm text-gray-400 mb-2">{{ doc.ecue.ue.name }} — {{ doc.ecue.name }}</p>
                                {% endif %}
                                <a href="{{ doc.file.url }}" class="text-primary hover:text-secondary transition" target="_blank">
                                    Télécharger <i class="fas fa-download ml-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="col-span-full text-center text-gray-400">
                        <i class="fas fa-folder-open text-4xl mb-4"></i>
                        <p>Aucun document disponible pour cette catégorie.</p>
                    </div>
                {% endfor %}
            {% else %}
                <div class="col-span-full text-center text-gray-400">
                    <i class="fas fa-hand-point-up text-4xl mb-4"></i>
                    <p>Veuillez sélectionner une catégorie ci-dessus.</p>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<script>
    function changeSemestre(semestre) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('semestre', semestre);
        window.location.href = `?${urlParams.toString()}`;
    }

    function changeUE(ueSlug) {
        const urlParams = new URLSearchParams(window.location.search);
        if (ueSlug) {
            urlParams.set('ue', ueSlug);
        } else {
            urlParams.delete('ue');
            urlParams.delete('ecue');
        }
        window.location.href = `?${urlParams.toString()}`;
    }

    function changeECUE(ecueSlug) {
        const urlParams = new URLSearchParams(window.location.search);
        if (ecueSlug) {
            urlParams.set('ecue', ecueSlug);
        } else {
            urlParams.delete('ecue');
        }
        window.location.href = `?${urlParams.toString()}`;
    }
</script>
{% endblock %}